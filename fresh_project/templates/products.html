{% extends 'admin_base.html' %}

{% block title %}Products - Fresh Farm Admin{% endblock %}
{% block nav_products_active %}active{% endblock %}
{% block page_title %}Products{% endblock %}
{% block page_subtitle %}Add products, update stock, and manage availability{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Products</h1>
    <p>Simple product list for quick edits and stock updates.</p>
</div>

<div class="toolbar">
    <form method="get" style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;">
        <input type="text" class="search-input" name="q" value="{{ query }}" placeholder="Search products">
        <input type="hidden" name="status" value="{{ status_filter }}">
        <input type="hidden" name="category" value="{{ category_filter }}">
    </form>
    <div class="pill-filters">
        <a href="{% url 'admin_products' %}?status={{ status_filter }}&category=all{% if query %}&q={{ query }}{% endif %}"
           class="pill pill-category{% if category_filter == 'all' %} active{% endif %}">All</a>
        <a href="{% url 'admin_products' %}?status={{ status_filter }}&category=fruits{% if query %}&q={{ query }}{% endif %}"
           class="pill pill-category{% if category_filter == 'fruits' %} active{% endif %}">Fruits</a>
        <a href="{% url 'admin_products' %}?status={{ status_filter }}&category=vegetables{% if query %}&q={{ query }}{% endif %}"
           class="pill pill-category{% if category_filter == 'vegetables' %} active{% endif %}">Vegetables</a>
    </div>
    <a href="{% url 'admin_product_add' %}" class="btn btn-primary">+ Add product</a>
</div>

{% if products %}
    <div class="card-grid" style="margin-top: 1rem;">
        {% for product in products %}
            <article class="card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">{{ product.name }}</h2>
                        <p class="muted-text">{{ product.category }}</p>
                    </div>
                    <div>
                        {% if not product.is_active or product.stock_quantity <= 0 %}
                            <span class="badge badge-muted">Unavailable</span>
                        {% elif product.stock_quantity <= low_stock_threshold %}
                            <span class="badge badge-warning">Low stock</span>
                        {% else %}
                            <span class="badge badge-success">Available</span>
                        {% endif %}
                    </div>
                </div>

                <p class="muted-text">Price: â‚±{{ product.price|floatformat:2 }} per kg</p>
                <p class="muted-text">Stock: {{ product.stock_quantity }} kg</p>

                <div class="toolbar" style="margin-top: 0.75rem;">
                    <a href="{% url 'admin_product_edit' product.pk %}" class="btn btn-outline btn-small">Edit</a>
                    <a href="{% url 'admin_product_stock' product.pk %}" class="btn btn-outline btn-small">Update stock</a>
                    <form method="post" action="{% url 'admin_product_toggle' product.pk %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline btn-small">Toggle availability</button>
                    </form>
                    <form method="post" action="{% url 'admin_product_delete' product.pk %}" style="display: inline;" onsubmit="return confirm('Delete this product?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger btn-small">Delete</button>
                    </form>
                </div>
            </article>
        {% endfor %}
    </div>
{% else %}
    <p class="muted-text">No products found.</p>
{% endif %}

{% if page_obj and page_obj.paginator.num_pages > 1 %}
    <div class="toolbar" style="margin-top: 1.5rem; justify-content: center;">
        {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}"
               class="btn btn-outline btn-small">Prev</a>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
            {% if num == page_obj.number %}
                <span class="btn btn-primary btn-small">{{ num }}</span>
            {% else %}
                <a href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                   class="btn btn-outline btn-small">{{ num }}</a>
            {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}"
               class="btn btn-outline btn-small">Next</a>
        {% endif %}
    </div>
{% endif %}
{% endblock %}

